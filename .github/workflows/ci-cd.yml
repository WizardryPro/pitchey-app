name: ğŸš€ Pitchey Platform CI/CD

on:
  push:
    branches: [ main, staging, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily health checks at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  FRONTEND_DIR: './frontend'
  WORKER_DIR: './src'
  
jobs:
  # =================================================================
  # SECURITY & CODE QUALITY CHECKS
  # =================================================================
  security-scan:
    name: ğŸ”’ Security & Quality Scan
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run security scan
        run: |
          if [ -f "scripts/security-scan.sh" ]; then
            chmod +x scripts/security-scan.sh
            ./scripts/security-scan.sh
          else
            echo "âš ï¸ Security scan script not found"
          fi

      - name: ğŸ” Check for hardcoded secrets
        run: |
          echo "ğŸ” Scanning for potential secrets..."
          grep -r -E "(api_key|secret|password|token)" --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" . || true
          echo "âœ… Secret scan completed"

  # =================================================================
  # FRONTEND BUILD & TEST
  # =================================================================
  frontend-test:
    name: ğŸ¨ Frontend Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    defaults:
      run:
        working-directory: ${{ env.FRONTEND_DIR }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --no-audit --prefer-offline
          echo "âœ… Dependencies installed"
          npx eslint --version || echo "âš ï¸ ESLint not found after install"

      - name: ğŸ§¹ Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: ğŸ”§ Type checking
        run: npm run type-check

      - name: ğŸ—ï¸ Build frontend
        run: npm run build
        env:
          VITE_API_URL: ''
          VITE_WS_URL: wss://pitchey-api-prod.ndlovucavelle.workers.dev
          VITE_DISABLE_WEBSOCKET: 'false'

      - name: ğŸ“Š Bundle size analysis
        run: |
          echo "ğŸ“Š Frontend build size:"
          du -sh dist/
          ls -la dist/assets/ || echo "No assets directory"

  # =================================================================
  # WORKER BUILD & TEST
  # =================================================================
  worker-test:
    name: âš¡ Worker Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Wrangler
        run: npm install -g wrangler@latest

      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build Worker
        run: npm run build:worker

      - name: ğŸ§ª Worker syntax validation
        run: |
          echo "ğŸ” Validating Worker syntax..."
          node -c dist/worker.js || echo "âš ï¸ Worker validation failed"

  # =================================================================
  # DATABASE TESTS
  # =================================================================
  database-test:
    name: ğŸ—„ï¸ Database Schema Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.event_name != 'schedule'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Schema validation
        run: |
          echo "ğŸ” Validating database schema files..."
          find . -name "*.sql" -type f -exec echo "ğŸ“„ Found SQL file: {}" \;
          
          if [ -f "scripts/fix-schema-alignment.sql" ]; then
            echo "âœ… Schema alignment file exists"
          else
            echo "âš ï¸ Schema alignment file missing"
          fi

  # =================================================================
  # STAGING DEPLOYMENT
  # =================================================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/develop'
    needs: [security-scan, frontend-test, worker-test]
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npm ci
          npm run build
        env:
          VITE_API_URL: ''
          VITE_WS_URL: wss://pitchey-api-staging.ndlovucavelle.workers.dev
          VITE_DISABLE_WEBSOCKET: 'false'

      - name: ğŸš€ Deploy Worker to staging
        run: |
          npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: ğŸš€ Deploy Frontend to staging
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npx wrangler pages deploy dist/ --project-name=pitchey
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  # =================================================================
  # PRODUCTION DEPLOYMENT
  # =================================================================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.ref == 'refs/heads/main'
    needs: [security-scan, frontend-test, worker-test, database-test]
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npm ci
          npm run build
        env:
          VITE_API_URL: ''
          VITE_WS_URL: wss://pitchey-api-prod.ndlovucavelle.workers.dev
          VITE_DISABLE_WEBSOCKET: 'false'

      - name: ğŸš€ Deploy Worker to production
        run: |
          npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: ğŸš€ Deploy Frontend to production
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          npx wrangler pages deploy dist/ --project-name=pitchey
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: ğŸ“Š Upload source maps to Sentry
        continue-on-error: true
        run: |
          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "âš ï¸ SENTRY_AUTH_TOKEN not configured, skipping source map upload"
            exit 0
          fi
          npx @sentry/cli releases new "${{ github.sha }}"
          npx @sentry/cli releases files "${{ github.sha }}" upload-sourcemaps frontend/dist --url-prefix '~/'
          npx @sentry/cli releases finalize "${{ github.sha }}"
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

  # =================================================================
  # E2E TESTS (Playwright)
  # =================================================================
  e2e-test:
    name: ğŸ­ E2E Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [deploy-production]
    continue-on-error: true
    defaults:
      run:
        working-directory: ${{ env.FRONTEND_DIR }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --no-audit --prefer-offline

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸ§ª Run E2E tests against production
        run: npx playwright test --project=critical-user-journeys --project=portal-functionality
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: https://pitchey-5o8.pages.dev

      - name: ğŸ“Š Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: ${{ env.FRONTEND_DIR }}/test-results/
          retention-days: 14

  # =================================================================
  # DAILY HEALTH MONITORING
  # =================================================================
  health-monitor:
    name: ğŸ¥ Daily Health Check
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¥ Run comprehensive health check
        run: |
          echo "ğŸ¥ Running daily health monitoring..."
          
          API_URL="https://pitchey-api-prod.ndlovucavelle.workers.dev"
          FRONTEND_URL="https://pitchey-5o8.pages.dev"
          
          # Test API health
          echo "ğŸ” Testing API health..."
          curl -f "$API_URL/api/health" || echo "âŒ API health check failed"
          
          # Test Frontend availability
          echo "ğŸ” Testing Frontend availability..."
          curl -f -I "$FRONTEND_URL" || echo "âŒ Frontend health check failed"
          
          # Test key endpoints
          echo "ğŸ” Testing key endpoints..."
          curl -f "$API_URL/api/pitches?limit=1" || echo "âŒ Pitches endpoint failed"
          
          echo "âœ… Health monitoring completed"

      - name: ğŸ“Š Performance monitoring
        run: |
          if [ -f "scripts/performance-check.sh" ]; then
            chmod +x scripts/performance-check.sh
            ./scripts/performance-check.sh
          else
            echo "âš ï¸ Performance check script not found"
          fi

      - name: ğŸ” Security monitoring
        run: |
          echo "ğŸ”’ Running security monitoring..."
          
          # Check for security headers
          API_URL="https://pitchey-api-prod.ndlovucavelle.workers.dev"
          
          echo "ğŸ” Checking security headers..."
          curl -I "$API_URL/api/health" | grep -E "(X-Frame-Options|Content-Security-Policy|X-Content-Type-Options)" || echo "âš ï¸ Some security headers missing"
          
          echo "âœ… Security monitoring completed"

  # =================================================================
  # CLEANUP & NOTIFICATIONS
  # =================================================================
  cleanup:
    name: ğŸ§¹ Cleanup & Notify
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: always()
    needs: [security-scan, frontend-test, worker-test, database-test, deploy-production]

    steps:
      - name: ğŸ“Š Job status summary
        run: |
          echo "ğŸ“Š CI/CD Pipeline Summary:"
          echo "================================"
          echo "ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
          echo "ğŸ¨ Frontend Tests: ${{ needs.frontend-test.result }}"
          echo "âš¡ Worker Tests: ${{ needs.worker-test.result }}"
          echo "ğŸ—„ï¸ Database Tests: ${{ needs.database-test.result }}"
          echo "ğŸš€ Production Deploy: ${{ needs.deploy-production.result }}"
          echo "================================"

      - name: ğŸš¨ Failure notification
        if: failure()
        run: |
          echo "ğŸš¨ Pipeline failed! Check the logs above for details."
          echo "ğŸ“§ In production, this would send notifications to the team."