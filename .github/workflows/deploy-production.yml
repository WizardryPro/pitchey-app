name: Manual Production Deployment
on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deployment)'
        required: false
        default: false
        type: boolean

jobs:
  # Run tests before deployment
  test:
    if: github.event.inputs.skip_tests != 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: Install root dependencies
        run: npm ci
        
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
          
      - name: Run type checking
        run: npm run type-check
        
      - name: Run linter
        run: npm run lint
        continue-on-error: true
        
      - name: Run frontend tests
        run: |
          cd frontend
          npm run test:unit
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: ''
          VITE_WS_URL: wss://pitchey-api-prod.ndlovucavelle.workers.dev
          VITE_DISABLE_WEBSOCKET: 'false'
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

  # Deploy Cloudflare Worker
  deploy-worker:
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Deploy Worker to Cloudflare
        run: |
          npm install -g wrangler
          wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: Update Worker secrets
        run: |
          echo "${{ secrets.NEON_DATABASE_URL }}" | wrangler secret put DATABASE_URL
          echo "${{ secrets.JWT_SECRET }}" | wrangler secret put JWT_SECRET
          echo "${{ secrets.UPSTASH_REDIS_REST_URL }}" | wrangler secret put UPSTASH_REDIS_REST_URL
          echo "${{ secrets.UPSTASH_REDIS_REST_TOKEN }}" | wrangler secret put UPSTASH_REDIS_REST_TOKEN
          echo "${{ secrets.SENTRY_DSN }}" | wrangler secret put SENTRY_DSN
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # Deploy frontend to Cloudflare Pages
  deploy-frontend:
    needs: [deploy-worker]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          VITE_API_URL: ''
          VITE_WS_URL: wss://pitchey-api-prod.ndlovucavelle.workers.dev
          VITE_DISABLE_WEBSOCKET: 'false'
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NODE_ENV: production
          
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: pitchey
          directory: frontend/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          deploymentName: production
          wranglerVersion: '3'
          
  # Run smoke tests
  smoke-test:
    needs: [deploy-frontend]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Wait for deployment to stabilize
        run: sleep 30
        
      - name: Health check - API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://pitchey-api-prod.ndlovucavelle.workers.dev/health)
          if [ $response -ne 200 ]; then
            echo "API health check failed with status $response"
            exit 1
          fi
          echo "✅ API is healthy"
          
      - name: Health check - Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://pitchey-5o8.pages.dev)
          if [ $response -ne 200 ]; then
            echo "Frontend health check failed with status $response"
            exit 1
          fi
          echo "✅ Frontend is accessible"
          
      - name: Database connectivity check
        run: |
          curl -s https://pitchey-api-prod.ndlovucavelle.workers.dev/health/database | jq .status
          
  # Notify deployment status
  notify:
    needs: [smoke-test]
    if: always()
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Send deployment notification
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ needs.smoke-test.result }}' === 'success' ? '✅' : '❌';
            const color = '${{ needs.smoke-test.result }}' === 'success' ? '28a745' : 'dc3545';
            
            // Create deployment first, then create status
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.sha,
                environment: 'production',
                description: 'Production deployment',
                auto_merge: false,
                required_contexts: []
              });
              
              // Create deployment status
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: '${{ needs.smoke-test.result }}' === 'success' ? 'success' : 'failure',
                environment_url: 'https://pitchey-5o8.pages.dev',
                description: `Deployment ${status}`,
              });
            } catch (error) {
              console.log('Could not create deployment status:', error.message);
              // Continue with notification even if deployment status fails
            }
            
            // Send Slack notification if webhook is configured
            const slackWebhook = '${{ secrets.SLACK_WEBHOOK }}';
            if (slackWebhook) {
              await fetch(slackWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: `${status} Production deployment completed`,
                  attachments: [{
                    color: color,
                    fields: [
                      { title: 'Environment', value: 'Production', short: true },
                      { title: 'Version', value: '${{ github.sha }}'.substring(0, 7), short: true },
                      { title: 'Deployed by', value: '${{ github.actor }}', short: true },
                      { title: 'Status', value: '${{ needs.smoke-test.result }}', short: true },
                    ],
                    actions: [
                      {
                        type: 'button',
                        text: 'View Site',
                        url: 'https://pitchey-5o8.pages.dev'
                      },
                      {
                        type: 'button', 
                        text: 'View Deployment',
                        url: '${{ github.event.head_commit.url }}'
                      }
                    ]
                  }]
                })
              });
            }
            
      - name: Create Sentry release
        if: needs.smoke-test.result == 'success'
        run: |
          npm install -g @sentry/cli
          export SENTRY_RELEASE="${{ github.sha }}"
          sentry-cli releases new $SENTRY_RELEASE
          sentry-cli releases set-commits $SENTRY_RELEASE --auto
          sentry-cli releases finalize $SENTRY_RELEASE
          sentry-cli releases deploys $SENTRY_RELEASE new -e production
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}