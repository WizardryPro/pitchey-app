name: Scheduled Tasks

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - backup
          - ssl-check
          - all

jobs:
  # Database backup
  backup:
    name: Database Backup
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.task == 'backup' ||
      github.event.inputs.task == 'all'

    steps:
      - uses: actions/checkout@v4

      - name: Create Database Backup
        run: |
          DATE=$(date +%Y%m%d_%H%M%S)
          pg_dump "${{ secrets.DATABASE_URL }}" | gzip > backup_${DATE}.sql.gz
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Upload to R2
        run: |
          npm install -g wrangler
          wrangler r2 object put pitchey-backups/db/backup_${DATE}.sql.gz \
            --file backup_${DATE}.sql.gz
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Clean Old Backups
        run: |
          # Keep only last 30 days of backups
          wrangler r2 object list pitchey-backups/db/ | \
            jq -r '.[] | select(.uploaded < (now - 2592000)) | .key' | \
            xargs -I {} wrangler r2 object delete pitchey-backups/{}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # SSL certificate check
  ssl-check:
    name: SSL Certificate Check
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: |
      github.event_name == 'schedule' ||
      github.event.inputs.task == 'ssl-check' ||
      github.event.inputs.task == 'all'

    steps:
      - name: Check SSL Expiration
        run: |
          expiry=$(echo | openssl s_client -connect pitchey-5o8.pages.dev:443 2>/dev/null | \
            openssl x509 -noout -enddate | cut -d= -f2)

          expiry_epoch=$(date -d "$expiry" +%s)
          current_epoch=$(date +%s)
          days_left=$(( ($expiry_epoch - $current_epoch) / 86400 ))

          echo "SSL certificate expires in $days_left days"

          if [ $days_left -lt 7 ]; then
            echo "SSL certificate expiring soon!"
            exit 1
          fi

      - name: Send SSL Alert
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: 'warning'
          text: 'SSL Certificate expiring in less than 7 days!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
