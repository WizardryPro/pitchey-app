# =====================================================
# Pitchey Production Configuration with Container Services
# Integrated deployment for existing production URLs
# =====================================================

# ===== MAIN WORKER CONFIGURATION =====
name = "pitchey-api-prod"
main = "src/worker-integrated.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat", "nodejs_als"]
account_id = "002bd5c0e90ae753a387c60546cf6869"

# Sentry version metadata for automatic release tracking
[version_metadata]
binding = "CF_VERSION_METADATA"

# Production domain routing (existing URLs) 
# Note: Using workers_dev = true instead of custom routes

# ===== CONTAINER SERVICES INTEGRATION =====
# Note: Container endpoints will be available at:
# https://pitchey-api-prod.ndlovucavelle.workers.dev/api/containers/*

# ===== DURABLE OBJECTS =====
[[durable_objects.bindings]]
name = "NOTIFICATION_HUB"
class_name = "NotificationHub"

[[durable_objects.bindings]]
name = "WEBSOCKET_ROOMS"
class_name = "WebSocketRoom"

[[migrations]]
tag = "v3"
new_classes = ["NotificationHub", "WebSocketRoom"]

# ===== R2 STORAGE =====
[[r2_buckets]]
binding = "PITCH_STORAGE"
bucket_name = "pitchey-pitches"

[[r2_buckets]]
binding = "NDA_STORAGE"
bucket_name = "pitchey-ndas"

[[r2_buckets]]
binding = "MEDIA_STORAGE"
bucket_name = "pitchey-media"

[[r2_buckets]]
binding = "PROCESSED_STORAGE"
bucket_name = "pitchey-processed"

[[r2_buckets]]
binding = "TEMP_STORAGE"
bucket_name = "pitchey-temp"

# ===== KV NAMESPACES =====
[[kv_namespaces]]
binding = "CACHE"
id = "5e9e940dc8af4f159f1bd027f3687dd3"

[[kv_namespaces]]
binding = "SESSION_STORE"
id = "d98b6fc5d3f44a1a87ab229e113f4047"

[[kv_namespaces]]
binding = "RATE_LIMITER"
id = "cb9e5601b3444205875e1723fe543446"

[[kv_namespaces]]
binding = "JOB_STATUS"
id = "65f0c620465046139f73416abb3f3ecd"

[[kv_namespaces]]
binding = "CONTAINER_METRICS"
id = "55fd8288547e4d57a2abb8b2590444f8"

# ===== QUEUES FOR CONTAINER PROCESSING =====
[[queues.producers]]
binding = "VIDEO_PROCESSING_QUEUE"
queue = "pitchey-video-processing"

[[queues.producers]]
binding = "DOCUMENT_PROCESSING_QUEUE"
queue = "pitchey-document-processing"

[[queues.producers]]
binding = "AI_INFERENCE_QUEUE"
queue = "pitchey-ai-inference"

[[queues.producers]]
binding = "MEDIA_TRANSCODING_QUEUE"
queue = "pitchey-media-transcoding"

[[queues.producers]]
binding = "CODE_EXECUTION_QUEUE"
queue = "pitchey-code-execution"

# Queue consumers will be configured after deployment

# ===== ANALYTICS ENGINE =====
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "pitchey_metrics"

[[analytics_engine_datasets]]
binding = "CONTAINER_ANALYTICS"
dataset = "pitchey_container_metrics"

[[analytics_engine_datasets]]
binding = "JOB_ANALYTICS"
dataset = "pitchey_job_analytics"

# Database Performance Analytics
[[analytics_engine_datasets]]
binding = "PITCHEY_ANALYTICS"
dataset = "pitchey_database_metrics"

[[analytics_engine_datasets]]
binding = "PITCHEY_PERFORMANCE"
dataset = "pitchey_performance_metrics"

[[analytics_engine_datasets]]
binding = "PITCHEY_ERRORS"
dataset = "pitchey_error_tracking"

# Distributed Tracing Analytics
[[analytics_engine_datasets]]
binding = "TRACE_ANALYTICS"
dataset = "pitchey_trace_events"

# ===== TRACE WORKERS CONFIGURATION =====
# Note: Trace Workers API for distributed tracing
# Temporarily disabled due to experimental features
# [[unsafe.bindings]]
# name = "TRACE_WORKERS"
# type = "trace_workers"

# Trace Workers Service Binding - commented out for now
# [[services]]
# binding = "TRACE_SERVICE"
# service = "trace-worker"
# environment = "production"

# ===== AUDIT LOG STORAGE =====
[[r2_buckets]]
binding = "AUDIT_LOGS"
bucket_name = "pitchey-audit-logs"

[[r2_buckets]]
binding = "TRACE_LOGS"
bucket_name = "pitchey-trace-logs"

# ===== CRON TRIGGERS =====
[triggers]
crons = [
  "*/5 * * * *",    # Every 5 min: Check NDA expirations and container health
  "*/10 * * * *",   # Every 10 min: Job queue monitoring
  "0 * * * *",      # Hourly: Send digest emails and metrics aggregation
  "0 0 * * *",      # Daily: Export audit logs and archive jobs
  "0 2 * * 1",      # Weekly: Database cleanup (Mondays at 2 AM)
  "*/15 * * * *"    # Every 15 min: Update trending algorithm
]

# ===== ENVIRONMENT VARIABLES =====
[vars]
# Platform Configuration
FRONTEND_URL = "https://pitchey-5o8.pages.dev"
BACKEND_URL = "https://pitchey-api-prod.ndlovucavelle.workers.dev"
ENVIRONMENT = "production"
VERSION = "2.0-integrated"

# Container Service Configuration
ENABLE_CONTAINERS = "true"
CONTAINER_ORCHESTRATION = "true"
CONTAINER_AUTO_SCALING = "true"
CONTAINER_HEALTH_MONITORING = "true"

# Processing Limits
MAX_VIDEO_PROCESSING_TIME = "1800"
MAX_DOCUMENT_PROCESSING_TIME = "300"
MAX_AI_INFERENCE_TIME = "120"
MAX_CODE_EXECUTION_TIME = "30"

# Feature Flags
ENABLE_DURABLE_OBJECTS = "true"
ENABLE_WEBSOCKETS = "true"
ENABLE_QUEUES = "true"
ENABLE_ANALYTICS = "true"
MAX_WEBSOCKET_CONNECTIONS = "100000"
CACHE_TTL = "300"

# Security Configuration
RATE_LIMITING_ENABLED = "true"
REQUEST_TIMEOUT_MS = "30000"
SANDBOX_EXECUTION = "true"

# Legacy Compatibility
REDIS_CACHE_ENABLED = "true"
ENABLE_EDGE_CACHING = "true"

# Authentication Configuration
BETTER_AUTH_URL = "https://pitchey-api-prod.ndlovucavelle.workers.dev"

# n8n Video Processing Webhook
N8N_WEBHOOK_URL = "http://localhost:5678/webhook/video-uploaded"

# Distributed Tracing Configuration
ENABLE_DISTRIBUTED_TRACING = "true"
TRACE_SAMPLING_RATE = "0.1"
TRACE_RETENTION_DAYS = "30"
ENABLE_AUDIT_LOGGING = "true"
AUDIT_LOG_RETENTION_DAYS = "90"
TRACE_CORRELATION_ENABLED = "true"

# Sentry Error Tracking
SENTRY_DSN = "https://fd5664ae577039ccb7cce31e91f54533@o4510137537396736.ingest.de.sentry.io/4510138308755536"
SENTRY_ENVIRONMENT = "production"
SENTRY_TRACES_SAMPLE_RATE = "0.1"

# Stripe (set via wrangler secret put)
# STRIPE_SECRET_KEY = "sk_live_..."
# STRIPE_WEBHOOK_SECRET = "whsec_..."

# Axiom Log Aggregation (set via wrangler secret)
# AXIOM_TOKEN = "your-axiom-api-token"
AXIOM_DATASET = "pitchey-logs"

# Observability Settings
LOG_LEVEL = "info"
SLOW_QUERY_THRESHOLD_MS = "1000"
LOG_ALL_QUERIES = "false"

# ===== OBSERVABILITY CONFIGURATION =====
[observability]
enabled = true

[observability.logs]
enabled = true
head_sampling_rate = 1.0
invocation_logs = true
persist = true

# ===== TAIL WORKERS FOR TRACE PROCESSING =====
# Temporarily disabled - will configure after deployment
# [[tail_consumers]]
# service = "pitchey-api-prod"
# environment = "production"
# namespace = "pitchey-traces"
# script_name = "pitchey-trace-processor"

# Build Configuration
[build]
command = "npm run build:worker"